<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f0f2f5; color: #333; margin: 0; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; position: sticky; top: 0; background: #f0f2f5; padding: 10px 0; z-index: 10; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #ddd; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #007bff; color: white; }
        .box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button.main-btn { width: 100%; background: #28a745; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .item-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #eee; }
        .item-row img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: #eee; }
        .item-info { flex: 1; overflow: hidden; }
        .item-info b { display: block; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .actions { display: flex; gap: 8px; }
        .del-btn { background: #ff4d4d; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }
        .edit-btn { background: #ffc107; color: black; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ */
        .order-card { padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; background: #fff; position: relative; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-select { padding: 5px; border-radius: 5px; font-weight: bold; width: auto; margin: 0; }
        .status-new { border-color: #007bff; color: #007bff; }
        .status-done { border-color: #28a745; color: #28a745; }
        .status-cancel { border-color: #dc3545; color: #dc3545; }
        .order-del-btn { position: absolute; bottom: 15px; right: 15px; background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-btn active" id="btn-products" onclick="switchTab('products')">–¢–æ–≤–∞—Ä—ã</button>
        <button class="tab-btn" id="btn-orders" onclick="switchTab('orders')">–ó–∞–∫–∞–∑—ã</button>
    </div>

    <div id="products-tab" class="tab-content active">
        <div class="box">
            <h3 id="form-title" style="margin-top:0">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
            <input type="hidden" id="p-id">
            <input type="text" id="p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="number" id="p-price" placeholder="–¶–µ–Ω–∞">
            <input type="text" id="p-art" placeholder="–ê—Ä—Ç–∏–∫—É–ª">
            <select id="p-cat">
                <option value="feb14">14 —Ñ–µ–≤—Ä–∞–ª—è</option>
                <option value="23and8">8 –º–∞—Ä—Ç–∞ –∏ 23 —Ñ–µ–≤—Ä–∞–ª—è</option>
                <option value="school">–®–∫–æ–ª—å–Ω—ã–µ —à–∞—Ä–∏–∫–∏</option>
                <option value="gender">–ì–µ–Ω–¥–µ—Ä–Ω—ã–µ —à–∞—Ä–∏–∫–∏</option>
                <option value="bday">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</option>
                <option value="vipiska">–ù–∞ –≤—ã–ø–∏—Å–∫—É</option>
                <option value="other">–î—Ä—É–≥–æ–µ</option>
            </select>
            <input type="file" id="p-file" accept="image/*">
            <button class="main-btn" id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button id="cancel-btn" style="display:none; width:100%; margin-top:10px; background:none; border:none; color:#007bff; cursor:pointer;">–û—Ç–º–µ–Ω–∞ / –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="box">
            <h3 style="margin-top:0">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <div id="products-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>
    </div>

    <div id="orders-tab" class="tab-content">
        <div class="box">
            <h3 style="margin-top:0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h3>
            <div id="orders-list">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
        </div>
    </div>

    <script>
        const h = { "ngrok-skip-browser-warning": "69420" };
        let currentImg = "img/no-photo.jpg";

        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            document.getElementById('save-btn').onclick = saveProduct;
            document.getElementById('cancel-btn').onclick = resetForm;
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            document.getElementById('btn-' + tab).classList.add('active');
            if(tab === 'products') loadProducts();
            if(tab === 'orders') loadOrders();
        }

        async function saveProduct() {
            const fileInput = document.getElementById('p-file');
            const pId = document.getElementById('p-id').value;
            let imgPath = currentImg;

            if (fileInput.files[0]) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                try {
                    document.getElementById('save-btn').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...";
                    const uploadRes = await fetch('/api/admin/upload', { method: 'POST', headers: h, body: formData });
                    const uploadData = await uploadRes.json();
                    imgPath = uploadData.img_path;
                } catch(e) { 
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ"); 
                    document.getElementById('save-btn').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä";
                    return; 
                }
            }

            const productData = {
                id: pId || null,
                name: document.getElementById('p-name').value,
                price: document.getElementById('p-price').value,
                art: document.getElementById('p-art').value,
                category: document.getElementById('p-cat').value,
                img: imgPath
            };

            const url = pId ? `/api/admin/edit_product` : `/api/admin/add_product`;
            
            try {
                const res = await fetch(url, { method: 'POST', headers: { ...h, "Content-Type": "application/json" }, body: JSON.stringify(productData) });
                if (res.ok) { resetForm(); loadProducts(); } 
                else { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
            } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        }

        function editItem(id, name, price, art, cat, img) {
            document.getElementById('p-id').value = id;
            document.getElementById('p-name').value = name;
            document.getElementById('p-price').value = price;
            document.getElementById('p-art').value = art;
            document.getElementById('p-cat').value = cat || 'other';
            currentImg = img;
            document.getElementById('form-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä (ID: " + id + ")";
            document.getElementById('save-btn').innerText = "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ";
            document.getElementById('cancel-btn').style.display = "block";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function resetForm() {
            document.getElementById('p-id').value = "";
            document.getElementById('p-name').value = "";
            document.getElementById('p-price').value = "";
            document.getElementById('p-art').value = "";
            document.getElementById('p-file').value = "";
            document.getElementById('form-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä";
            document.getElementById('save-btn').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä";
            document.getElementById('cancel-btn').style.display = "none";
            currentImg = "img/no-photo.jpg";
        }

        async function loadProducts() {
            const list = document.getElementById('products-list');
            try {
                const res = await fetch(`/api/products?v=${Date.now()}`, { headers: h });
                const data = await res.json();
                list.innerHTML = data.map(p => `
                    <div class="item-row">
                        <img src="${p.img.startsWith('http') ? p.img : '/' + p.img}" onerror="this.src='/img/no-photo.jpg'">
                        <div class="item-info">
                            <b>${p.name}</b>
                            <small>${p.price} ‚ÇΩ | –ê—Ä—Ç: ${p.art || '-'}</small>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" onclick="editItem(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price}, '${p.art || ''}', '${p.category_id}', '${p.img}')">‚úé</button>
                            <button class="del-btn" onclick="deleteItem(${p.id})">‚úï</button>
                        </div>
                    </div>
                `).join('') || "–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç";
            } catch(e) { list.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
        }

        async function deleteItem(id) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")) return;
            await fetch(`/api/admin/product/${id}`, { method: 'DELETE', headers: h });
            loadProducts();
        }

        async function loadOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
            try {
                const res = await fetch('/api/admin/orders', { headers: h });
                const data = await res.json();
                
                if(data.length === 0) { list.innerHTML = "–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç"; return; }

                list.innerHTML = data.map(o => {
                    const status = o.status || 'new';
                    return `
                    <div class="order-card">
                        <div class="order-header">
                            <b>–ó–∞–∫–∞–∑ #${o.id}</b>
                            <select class="status-select status-${status}" onchange="updateStatus(${o.id}, this.value)">
                                <option value="new" ${status==='new'?'selected':''}>üÜï –ù–æ–≤—ã–π</option>
                                <option value="done" ${status==='done'?'selected':''}>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω</option>
                                <option value="cancel" ${status==='cancel'?'selected':''}>‚ùå –û—Ç–º–µ–Ω–µ–Ω</option>
                            </select>
                        </div>
                        <div style="font-size:14px; margin-bottom:10px;">–°—É–º–º–∞: <b>${o.total_price} ‚ÇΩ</b></div>
                        <small style="color: #555; display:block; white-space:pre-wrap;">${o.details}</small>
                        <button class="order-del-btn" onclick="deleteOrder(${o.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `}).join('');
            } catch(e) { list.innerHTML = "–û—à–∏–±–∫–∞: " + e.message; }
        }

        async function updateStatus(id, newStatus) {
            try {
                const res = await fetch('/api/admin/order/update', {
                    method: 'POST',
                    headers: { ...h, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, status: newStatus })
                });
                if(res.ok) loadOrders();
            } catch(e) { alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞"); }
        }

        async function deleteOrder(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
            try {
                const res = await fetch(`/api/admin/order/${id}`, { method: 'DELETE', headers: h });
                if(res.ok) loadOrders();
            } catch(e) { alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"); }
        }
    </script>
</body>
</html>
