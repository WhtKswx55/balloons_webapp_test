const API_BASE = 'https://lynell-undelaying-exorbitantly.ngrok-free.dev';
const h = { "ngrok-skip-browser-warning": "69420" };
let currentImg = "img/no-photo.jpg";

const categories = [
    { id: 'feb14', name: '14 февраля' },
    { id: '23and8', name: '8 марта и 23 февраля' },
    { id: 'school', name: 'Школьные шарики' },
    { id: 'gender', name: 'Гендерные шарики' },
    { id: 'bday', name: 'День рождения' },
    { id: 'vipiska', name: 'На выписку' },
    { id: 'other', name: 'Другое' }
];

function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tab + '-tab').classList.add('active');
    document.getElementById('btn-' + tab).classList.add('active');
    tab === 'products' ? loadProducts() : loadOrders();
}

async function saveProduct() {
    const btn = document.getElementById('save-btn');
    const fileInput = document.getElementById('p-file');
    const pId = document.getElementById('p-id').value;

    const name = document.getElementById('p-name').value.trim();
    const price = parseFloat(document.getElementById('p-price').value);
    
    if (!name || isNaN(price)) {
        alert("Укажите название и цену!");
        return;
    }

    btn.disabled = true;
    btn.innerText = "Загрузка...";

    try {
        let imgPath = currentImg;

        if (fileInput.files && fileInput.files[0]) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const uploadRes = await fetch(`${API_BASE}/api/admin/upload`, { 
                method: 'POST', 
                headers: h, 
                body: formData 
            });
            if (uploadRes.ok) {
                const uploadData = await uploadRes.json();
                imgPath = uploadData.img_path;
            }
        }

        const data = {
            id: pId ? parseInt(pId) : null,
            name: name,
            price: price,
            art: document.getElementById('p-art').value.trim(),
            category: document.getElementById('p-cat').value,
            description: document.getElementById('p-desc').value.trim(),
            img: imgPath
        };

        const url = pId ? `${API_BASE}/api/admin/edit_product` : `${API_BASE}/api/admin/add_product`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { ...h, "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            resetForm();
            await loadProducts();
            alert("Сохранено!");
        } else {
            alert("Ошибка сервера при сохранении");
        }
    } catch (e) {
        console.error(e);
        alert("Критическая ошибка: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "Сохранить";
    }
}

async function loadProducts() {
    const list = document.getElementById('products-list');
    if (!list) return;

    try {
        const res = await fetch(`${API_BASE}/api/products?v=${Date.now()}`, { headers: h });
        const data = await res.json();

        let html = '';
        categories.forEach(cat => {
            const catItems = data.filter(p => String(p.category_id) === String(cat.id));
            if (catItems.length > 0) {
                html += `<div class="category-header">${cat.name}</div>`;
                html += catItems.map(p => {
                    const pic = p.img.startsWith('http') ? p.img : `${API_BASE}/${p.img}`;
                    return `
                    <div class="item-row">
                        <img src="${pic}" onerror="this.src='img/no-photo.jpg'">
                        <div style="flex:1"><b>${p.name}</b><br><small>${p.price}₽</small></div>
                        <div class="actions">
                            <button class="edit-btn" onclick="editItem(${p.id}, \`${p.name.replace(/`/g, '')}\`, ${p.price}, '${p.art}', '${p.category_id}', '${p.img}', \`${(p.description || '').replace(/`/g, '')}\`)">✎</button>
                            <button class="del-btn" onclick="deleteItem(${p.id})">✕</button>
                        </div>
                    </div>`;
                }).join('');
            }
        });
        list.innerHTML = html || "Товаров нет";
    } catch (e) { console.error("Ошибка загрузки товаров:", e); }
}

function editItem(id, name, price, art, cat, img, desc) {
    document.getElementById('p-id').value = id;
    document.getElementById('p-name').value = name;
    document.getElementById('p-price').value = price;
    document.getElementById('p-art').value = art;
    document.getElementById('p-cat').value = cat;
    document.getElementById('p-desc').value = desc;
    currentImg = img;
    document.getElementById('form-title').innerText = "Редактировать";
    document.getElementById('cancel-btn').style.display = "block";
    window.scrollTo(0,0);
}

function resetForm() {
    document.getElementById('p-id').value = "";
    document.getElementById('p-name').value = "";
    document.getElementById('p-price').value = "";
    document.getElementById('p-art').value = "";
    document.getElementById('p-cat').value = "feb14";
    document.getElementById('p-desc').value = "";
    document.getElementById('p-file').value = "";
    document.getElementById('form-title').innerText = "Добавить товар";
    document.getElementById('cancel-btn').style.display = "none";
    currentImg = "img/no-photo.jpg";
}

async function loadOrders() {
    const list = document.getElementById('orders-list');
    try {
        const res = await fetch(`${API_BASE}/api/admin/orders`, { headers: h });
        const data = await res.json();
        list.innerHTML = data.map(o => `
            <div class="order-card">
                <b>Заказ #${o.id}</b>
                <select onchange="updateStatus(${o.id}, this.value)">
                    <option value="new" ${o.status==='new'?'selected':''}>Новый</option>
                    <option value="done" ${o.status==='done'?'selected':''}>Готов</option>
                    <option value="cancel" ${o.status==='cancel'?'selected':''}>Отмена</option>
                </select>
                <div>${o.total_price} ₽</div>
                <button class="del-btn" onclick="deleteOrder(${o.id})">Удалить</button>
            </div>`).join('');
    } catch (e) { console.error(e); }
}

async function updateStatus(id, status) {
    await fetch(`${API_BASE}/api/admin/order/update`, {
        method: 'POST',
        headers: { ...h, 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status })
    });
}

async function deleteItem(id) { if(confirm("Удалить?")) { await fetch(`${API_BASE}/api/admin/product/${id}`, {method:'DELETE', headers:h}); loadProducts(); } }
async function deleteOrder(id) { if(confirm("Удалить заказ?")) { await fetch(`${API_BASE}/api/admin/order/${id}`, {method:'DELETE', headers:h}); loadOrders(); } }

loadProducts();
